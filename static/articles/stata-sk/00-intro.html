<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr">
<head>
<!-- 2018-07-02 Lun 09:21 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stata : un rapide tour d&rsquo;horizon</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Christophe Lalanne" />
<link rel="stylesheet" type="text/css" href="worg.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 90,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 90,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 90},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Stata : un rapide tour d&rsquo;horizon</h1>
<div id="table-of-contents">
<h2>Table des matières</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgcc38bbe">Stata en quelques mots</a></li>
<li><a href="#org0befc95">Prise en main de Stata</a>
<ul>
<li><a href="#org9269c10">Un modèle de régression linéaire</a></li>
<li><a href="#org86f4104">Visualiser et interpréter</a></li>
<li><a href="#org8306261">Synthétiser</a></li>
</ul>
</li>
<li><a href="#orgc512251">Enregistrer son travail</a></li>
<li><a href="#orga01cf06">Pour aller plus loin</a></li>
</ul>
</div>
</div>
<p>
Ce document présente selon un angle très pragmatique une session de travail typique avec le logiciel Stata. Il ne s&rsquo;agit pas de couvrir toutes les fonctionnalités de Stata, ni de présenter en détails les principales commandes Stata, voire même la représentation interne des données sus Stata. Au contraire, l&rsquo;idée est d&rsquo;offrir un panorama de certaines fonctionnalités de Stata et comment organiser une session de travail simple avec comme objectif la réalisation d&rsquo;un modèle de régression linéaire.
</p>

<div id="outline-container-orgcc38bbe" class="outline-2">
<h2 id="orgcc38bbe">Stata en quelques mots</h2>
<div class="outline-text-2" id="text-orgcc38bbe">
<p>
Stata est un logiciel d&rsquo;analyses statistiques développé dans les années 80 par une équipe de statisticiens américains, dont William Gould. À l&rsquo;origine, il s&rsquo;agissait esentiellement d&rsquo;un logiciel orienté vers le traitement des enquêtes et des séries chronologiques [<a href="#cox-2005-stata">2</a>], puis ses fonctionnalités se sont largement développées pour en faire à l&rsquo;heure actuelle un logiciel très performant dans de nombreux domaines d&rsquo;application, principalement le traitement des enquêtes [<a href="#kohler-2012-data-analy">4</a>], l&rsquo;économétrie [<a href="#baum-2006-introd-moder">1</a>] ou l&rsquo;épidémiologie [<a href="#juul-2014-introd-stata">3</a>]. Les ouvrages publiés par Stata Press incluent en général un ou deux chapitres de présentation des principales commandes Stata.
</p>

<p>
Une fois installé, le logiciel Stata est entièrement fonctionnel et dispose de toutes les procédures statistiques et graphiques que l&rsquo;on attend d&rsquo;un logiciel statistique. Il est toutefois possible d&rsquo;installer des modules additionnels depuis internet (<a href="http://www.stata.com">www.stata.com</a>, <a href="http://repec.org">SSC</a>, <a href="https://github.com">Github</a>, sites personnels). Mais en règle générale, les commandes de base disponibles dans Stata suffisent largement à couvrir l&rsquo;essentiel des besoins en termes de gestion de données et d&rsquo;analyses statistiques. 
</p>

<p>
Une autre caractéristique remarquable de Stata est la qualité de sa documentation. Pour la version 15, on dénombre pas moins 30 manuels en version PDF pour un total de 14791 pages.<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup> Ces documents PDF sont accessibles depuis le menu d&rsquo;aide interne de Stata et se consulte généralement à l&rsquo;aide d&rsquo;Acrobat Reader, mais il est toujours possible de consulter le fichier d&rsquo;index &laquo;&nbsp;i.pdf&nbsp;&raquo; et de naviguer dans la documentation à partir de celui-ci. Pour bien débuter avec Stata, il est conseillé de lire le manuel [D] (Data management).
</p>

<p>
En mode interactif, il y a deux manières de travailler avec Stata : en saisissant des instructions dans le panneau de commande ou en utilisant les menus et boîtes de dialogue de l&rsquo;interface graphique. On privilégira la première option par souci de simplicité pour l&rsquo;exposé et à plus long terme de reproducibilité des analyses statistiques puisque l&rsquo;on verra comment enregistrer toutes les commandes dans un fichier appelé fichier &laquo;&nbsp;do&nbsp;&raquo; ou <i>do-file</i>.
</p>
</div>
</div>

<div id="outline-container-org0befc95" class="outline-2">
<h2 id="org0befc95">Prise en main de Stata</h2>
<div class="outline-text-2" id="text-org0befc95">
</div>
<div id="outline-container-org9269c10" class="outline-3">
<h3 id="org9269c10">Un modèle de régression linéaire</h3>
<div class="outline-text-3" id="text-org9269c10">
<p>
Une fois Stata lancé, voici quelques commandes à saisir dans le panneau de commande. Il s&rsquo;agit du panneau central dans l&rsquo;interface Stata, de hauteur réduite et intitulé &laquo;&nbsp;Command&nbsp;&raquo;. Il est généralement situé en dessous du panneau de résultats (&laquo;&nbsp;Results&nbsp;&raquo;). Ce sont les seuls éléments de l&rsquo;interface graphique de Stata qui nous intéresseront dans ce tutoriel.  Ces trois commandes vont successivement charger un jeu de données fourni lors de l&rsquo;installation de Stata, produire un résumé numérique de deux variables, appelées <code>price</code> et <code>mpg</code>, et estimer les paramètres d&rsquo;un modèle de régression linéaire simple.
</p>
<div class="org-src-container">
<pre class="src src-stata">sysuse auto, clear
summarize price mpg
regress price mpg
</pre>
</div>

<pre class="example">
set more off
sysuse auto, clear
(1978 Automobile Data)
summarize price mpg

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
       price |         74    6165.257    2949.496       3291      15906
         mpg |         74     21.2973    5.785503         12         41
regress price mpg

      Source |       SS           df       MS      Number of obs   =        74
-------------+----------------------------------   F(1, 72)        =     20.26
       Model |   139449474         1   139449474   Prob &gt; F        =    0.0000
    Residual |   495615923        72  6883554.48   R-squared       =    0.2196
-------------+----------------------------------   Adj R-squared   =    0.2087
       Total |   635065396        73  8699525.97   Root MSE        =    2623.7

------------------------------------------------------------------------------
       price |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         mpg |  -238.8943   53.07669    -4.50   0.000    -344.7008   -133.0879
       _cons |   11253.06   1170.813     9.61   0.000     8919.088    13587.03
------------------------------------------------------------------------------
</pre>

<p>
Dans l&rsquo;exemple ci-dessus comme dans les suivants, on présentera systématiquement une commande ou une série de commandes suivi des résultats produits par Stata. Le deuxième encart reflète donc la sortie produite par Stata dans sa fenêtre &laquo;&nbsp;Results&nbsp;&raquo;, à l&rsquo;exception de l&rsquo;invite de commande Stata symbolisée par un point (&laquo;&nbsp;.&nbsp;&raquo;). Pour en revenir à l&rsquo;exemple précédent, deux choses sont remarquables : (1) les commandes Stata suivent l&rsquo;idée anglo-saxonne que l&rsquo;on peut se faire des actions que l&rsquo;on souhaite réaliser (<a href="https://www.stata.com/help.cgi?use" class="stata">use</a> pour utiliser et <a href="https://www.stata.com/help.cgi?sysuse" class="stata">sysuse</a> pour utiliser depuis le système, <a href="https://www.stata.com/help.cgi?summarize" class="stata">summarize</a> pour résumer, et <a href="https://www.stata.com/help.cgi?regress" class="stata">regress</a> pour régresser une variable sur une autre) ; (2) dans la majorité des cas, une commande produit un résultat, qu&rsquo;il s&rsquo;agisse de l&rsquo;affichage d&rsquo;un message ou d&rsquo;un résultat numérique mis en forme automatiquement par Stata.
</p>

<p>
Le jeu de données utilisé concerne un ensemble de voitures dont l&rsquo;une des caractéristiques est l&rsquo;origine de la marque : la variable <code>foreign</code> indique si la voiture est de marque étrangère (<code>foreign = 1</code>) ou non (<code>foreign = 0</code>). Pour avoir une idée plus précise de l&rsquo;ensemble des variables disponibles dans ce tableau de données, on peut utiliser la commande <a href="https://www.stata.com/help.cgi?codebook" class="stata">codebook</a> ou <a href="https://www.stata.com/help.cgi?describe" class="stata">describe</a> :
</p>
<div class="org-src-container">
<pre class="src src-stata">describe
</pre>
</div>

<pre class="example">
describe

Contains data from /Applications/Stata/ado/base/a/auto.dta
  obs:            74                          1978 Automobile Data
 vars:            12                          13 Apr 2016 17:45
 size:         3,182                          (_dta has notes)
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
make            str18   %-18s                 Make and Model
price           int     %8.0gc                Price
mpg             int     %8.0g                 Mileage (mpg)
rep78           int     %8.0g                 Repair Record 1978
headroom        float   %6.1f                 Headroom (in.)
trunk           int     %8.0g                 Trunk space (cu. ft.)
weight          int     %8.0gc                Weight (lbs.)
length          int     %8.0g                 Length (in.)
turn            int     %8.0g                 Turn Circle (ft.)
displacement    int     %8.0g                 Displacement (cu. in.)
gear_ratio      float   %6.2f                 Gear Ratio
foreign         byte    %8.0g      origin     Car type
-------------------------------------------------------------------------------
Sorted by: foreign
</pre>

<p>
Notons qu&rsquo;aucun nom de variable n&rsquo;est fourni après la commande <a href="https://www.stata.com/help.cgi?describe" class="stata">describe</a>, ce qui revient à considérer l&rsquo;ensemble des variables. Il serait équivalent de spécifier explicitement les variables à l&rsquo;aide de <code>describe make-foreign</code> ou <code>describe *</code>. La notion de variable et de liste de variables est centrale dans l&rsquo;utilisation de Stata qui est un langage essentiellement orienté variables (c&rsquo;est-à-dire les colonnes du tableau de données). Les commandes Stata possèdent généralement des options qui modifient leur comportement ou les résultats renvoyés dans la fenêtre de résultats. Dans le cas de <a href="https://www.stata.com/help.cgi?describe" class="stata">describe</a>, par exemple, l&rsquo;option <code>simple</code> permet de lister uniquement le nom des variables. Les options se placent après les paramètres principaux de la commande et d&rsquo;une virgule &laquo;&nbsp;,&nbsp;&raquo;. On écrirait donc <code>describe, simple</code>. Enfin, les commandes peuvent être abrégées à l&rsquo;aide du plus petit préfixe non ambigü, et le nom de commande abrégé apparaît souligné dans l&rsquo;aide en ligne de Stata (<code>help describe</code>). 
</p>

<p>
Supposons que l&rsquo;on souhaite réaliser le même modèle de régression que le précédent mais en restreignant l&rsquo;analyse aux seuls véhicules de marque étrangère. Pour cela, il suffit d&rsquo;appliquer un filtre pour sélectionner les observations vérifiant la condition <code>foreign==1</code> (&laquo;&nbsp;la variable <code>foreign</code> prend la valeur 1&nbsp;&raquo;) :
</p>
<div class="org-src-container">
<pre class="src src-stata">regress price mpg if foreign == 1
</pre>
</div>

<pre class="example">
regress price mpg if foreign == 1

      Source |       SS           df       MS      Number of obs   =        22
-------------+----------------------------------   F(1, 20)        =     13.25
       Model |  57534941.7         1  57534941.7   Prob &gt; F        =    0.0016
    Residual |  86828271.1        20  4341413.55   R-squared       =    0.3985
-------------+----------------------------------   Adj R-squared   =    0.3685
       Total |   144363213        21   6874438.7   Root MSE        =    2083.6

------------------------------------------------------------------------------
       price |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         mpg |  -250.3668   68.77435    -3.64   0.002    -393.8276    -106.906
       _cons |   12586.95   1760.689     7.15   0.000     8914.217    16259.68
------------------------------------------------------------------------------
</pre>

<p>
La notion de filtres appliqués à l&rsquo;aide des qualificateurs <a href="https://www.stata.com/help.cgi?by" class="stata">by</a>, <a href="https://www.stata.com/help.cgi?if" class="stata">if</a> et <a href="https://www.stata.com/help.cgi?in" class="stata">in</a> est également centrale dans Stata puisque ceux-ci permettent de sélectionner un sous-ensemble d&rsquo;observations (les lignes du tableau de données) selon des conditions logiques. À ce titre, le symbole représetant l&rsquo;égalité logique est un double signe égal (<code>==</code>) alors que le signe égal simple est réservé à l&rsquo;opération d&rsquo;affectation. Il serait possible de réutiliser la même instruction pour estimer le modèle de régression pour les observations vérifiant la condition &laquo;&nbsp;foreign vaut 0&nbsp;&raquo;, mais plutôt que de copier/coller ou rappeller la même commande à l&rsquo;aide des flèches haut/bas du clavier dans la fenêtre de commande, il est préférable d&rsquo;utiliser le préfixe <a href="https://www.stata.com/help.cgi?by" class="stata">by</a> :
</p>
<div class="org-src-container">
<pre class="src src-stata">by foreign, sort: regress price mpg
</pre>
</div>

<pre class="example">
by foreign, sort: regress price mpg

-------------------------------------------------------------------------------
-&gt; foreign = Domestic

      Source |       SS           df       MS      Number of obs   =        52
-------------+----------------------------------   F(1, 50)        =     17.05
       Model |   124392956         1   124392956   Prob &gt; F        =    0.0001
    Residual |   364801844        50  7296036.89   R-squared       =    0.2543
-------------+----------------------------------   Adj R-squared   =    0.2394
       Total |   489194801        51  9592054.92   Root MSE        =    2701.1

------------------------------------------------------------------------------
       price |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         mpg |  -329.2551   79.74034    -4.13   0.000    -489.4183   -169.0919
       _cons |   12600.54   1624.773     7.76   0.000     9337.085    15863.99
------------------------------------------------------------------------------

-------------------------------------------------------------------------------
-&gt; foreign = Foreign

      Source |       SS           df       MS      Number of obs   =        22
-------------+----------------------------------   F(1, 20)        =     13.25
       Model |  57534941.7         1  57534941.7   Prob &gt; F        =    0.0016
    Residual |  86828271.1        20  4341413.55   R-squared       =    0.3985
-------------+----------------------------------   Adj R-squared   =    0.3685
       Total |   144363213        21   6874438.7   Root MSE        =    2083.6

------------------------------------------------------------------------------
       price |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         mpg |  -250.3668   68.77435    -3.64   0.002    -393.8276    -106.906
       _cons |   12586.95   1760.689     7.15   0.000     8914.217    16259.68
------------------------------------------------------------------------------
</pre>

<p>
Si l&rsquo;on souhaite obtenir les intervalles de confiance estimés pour nos paramètres à l&rsquo;aide d&rsquo;une technique de rééchantillonnage comme le bootstrap, il suffit de l&rsquo;indiquer à Stata à l&rsquo;aide du préfixe correspondant (<a href="https://www.stata.com/help.cgi?bootstrap:" class="stata">bootstrap:</a>) : la commande s&rsquo;écrit alors <code>bootstrap: regress price mpg</code>. Un autre préfixe possible est <a href="https://www.stata.com/help.cgi?bayes:" class="stata">bayes:</a> (à partir de Stata 15) et, dans ce cas, ce sont des intervalles de crédibilité qui seront calculés automatiquement par Stata. On remplacera la commande précédente par <code>bayes: regress price mpg</code>. Attention, il ne s&rsquo;agit pas d&rsquo;un préfixe comme le préfixe <a href="https://www.stata.com/help.cgi?by" class="stata">by</a> vu plus haut, mais d&rsquo;un préfixe pour les commandes d&rsquo;estimation.
</p>

<p>
Voici, en quelques mots, le mode de fonctionnement de base de Stata pour réaliser un modèle statistique : choisir la commande appropriée, indiquer les variables entrant dans le modèle sachant que la première variable joue toujours le rôle de variable réponse ou de variable à prédire, et éventuellement filtrer les observartions à utiliser dans le modèle. La syntaxe plus générale d&rsquo;une commande prend la forme suivante :
</p>
<pre class="example">
[by varlist:] command [varlist] [=exp] [if exp] [in range] [weight] [using filename] [,options]
</pre>
<p>
On reconnaît le préfixe <a href="https://www.stata.com/help.cgi?by" class="stata">by</a> et les qualificateurs <a href="https://www.stata.com/help.cgi?in" class="stata">in</a> et <a href="https://www.stata.com/help.cgi?if" class="stata">if</a>, permettant de sélectionner les observations et de répéter une même opération pour chaque groupe d&rsquo;observations défini par les valeurs prises par la ou les variables désignées après le préfixe <a href="https://www.stata.com/help.cgi?by" class="stata">by</a> (la plupart des commandes Stata sont &laquo;&nbsp;byable&nbsp;&raquo;). La commande est suivi d&rsquo;une ou plusieurs variables (une liste, appelée <a href="https://www.stata.com/help.cgi?varlist" class="stata">varlist</a>) et éventuellement d&rsquo;une expression (<code>=exp</code>) dans le cas où on construit explicitement la variable (cas de <a href="https://www.stata.com/help.cgi?generate" class="stata">generate</a>). Des poids de pondération (<a href="https://www.stata.com/help.cgi?weight" class="stata">weight</a>) peuvent être appliquées aux principales commandes Stata et il est possible d&rsquo;interagir avec des fichiers externes à l&rsquo;aide de <a href="https://www.stata.com/help.cgi?using" class="stata">using</a>. Enfin, comme dit plus haut, les options des commandes sont indiquées après une virgule.
</p>
</div>
</div>

<div id="outline-container-org86f4104" class="outline-3">
<h3 id="org86f4104">Visualiser et interpréter</h3>
<div class="outline-text-3" id="text-org86f4104">
<p>
Les instructions suivantes vont permettre de construire un diagramme de dispersion représentant la covariation des deux variables <code>price</code> et <code>mpg</code> et d&rsquo;y superposer la droite de régression. Les mots clé <a href="https://www.stata.com/help.cgi?graph" class="stata">graph</a> et <a href="https://www.stata.com/help.cgi?twoway" class="stata">twoway</a> peuvent être omis et le symbole <code>||</code> permet de superposer sur le même graphique plusieurs éléments. L&rsquo;ancienne syntaxe consistant à isoler les instructions graphiques entre parenthèses est également valide.
</p>

<p>
<b>Remarque :</b>  Les graphiques présentés dans ce document utilisent un schéma graphique spécifique, <code>plotplain</code>, qui peut être installé depuis le serveur SSC en tapant simplement la commande <code>ssc install blindschemes</code>. Pour rester cohérent avec la police utilisée dans ce document et parce qu&rsquo;il n&rsquo;est pas possible de définir la police des graphiques lorsque Stata est lancé en mode console, on utilisera systématiquement l&rsquo;option <code>fontface()</code>, mais celle-ci peut être omise sans problème.
</p>

<p>
Voici donc pour le diagramme de dispersion et la droite de régression. L&rsquo;ordre des variables suit celui du modèle de régression, et dans le cas des graphiques la première variable est représentée sur l&rsquo;axe des ordonnées (verticalement) :
</p>
<div class="org-src-container">
<pre class="src src-stata">set scheme plotplain
graph twoway scatter price mpg || lfit price mpg 
graph export "fig-00-scatter-price-mpg.pdf", fontface(DroidSans) replace
</pre>
</div>


<div id="org55517f7" class="figure">
<p><img src="./fig-00-scatter-price-mpg.png" alt="fig-00-scatter-price-mpg.png" width="640px" />
</p>
<p><span class="figure-number">Figure&nbsp;1&nbsp;: </span>Prix et vitesse des automobiles (ajustement linéaire)</p>
</div>

<p>
Le graphique précédent suggère qu&rsquo;une relation simplement linéaire entre les deux variables n&rsquo;est pas vraiment satisfaisante. On peut imaginer utiliser une approche par polynômes ou par splines, mais dans l&rsquo;immédiat ajoutons simplement un terme quadratique :
</p>
<div class="org-src-container">
<pre class="src src-stata">generate mpg2 = mpg * mpg
regress price mpg mpg2 
</pre>
</div>

<pre class="example">
generate mpg2 = mpg * mpg
regress price mpg mpg2

      Source |       SS           df       MS      Number of obs   =        74
-------------+----------------------------------   F(2, 71)        =     18.28
       Model |   215835615         2   107917807   Prob &gt; F        =    0.0000
    Residual |   419229781        71  5904644.81   R-squared       =    0.3399
-------------+----------------------------------   Adj R-squared   =    0.3213
       Total |   635065396        73  8699525.97   Root MSE        =    2429.9

------------------------------------------------------------------------------
       price |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         mpg |  -1265.194   289.5443    -4.37   0.000    -1842.529   -687.8593
        mpg2 |   21.36069   5.938885     3.60   0.001     9.518891    33.20249
       _cons |   22716.48   3366.577     6.75   0.000     16003.71    29429.24
------------------------------------------------------------------------------
</pre>

<p>
Comme on le voit, la génération d&rsquo;une nouvelle variable ne pose pas de difficulté majeure et il n&rsquo;est même pas besoin de définir son type : Stata est capable d&rsquo;inférer que la variable <code>mpg2</code> est un nombre réel puisqu&rsquo;elle est construite à partir du produit d&rsquo;un nombre réel par lui même. La mise à jour du modèle linéaire est relativement simple puisqu&rsquo;il suffit d&rsquo;ajouter le nouveau prédicteur à la suite du prédicteur initial, <code>mpg</code>.
</p>

<p>
Pour construire un graphique incluant la courbe d&rsquo;ajustement quadratique, on remplace simplement <a href="https://www.stata.com/help.cgi?lfit" class="stata">lfit</a> par <a href="https://www.stata.com/help.cgi?qfit" class="stata">qfit</a> comme illustré ci-après :
</p>
<div class="org-src-container">
<pre class="src src-stata">graph twoway scatter price mpg || qfit price mpg
graph export "fig-00-scatter-price-mpg2.pdf", fontface(DroidSans) replace
</pre>
</div>


<div id="orga186f73" class="figure">
<p><img src="./fig-00-scatter-price-mpg2.png" alt="fig-00-scatter-price-mpg2.png" width="640px" />
</p>
<p><span class="figure-number">Figure&nbsp;2&nbsp;: </span>Prix et vitesse des automobiles (ajustement quadratique)</p>
</div>

<p>
Les résultats calculés par Stata sont stockés en mémoire et sont disponibles immédiatement après une telle commande d&rsquo;estimation. Par exemple, ci-après on affiche la valeur de retour <code>r2_a</code>, qui représente le coefficeint de détermination du modèle précédent :
</p>
<div class="org-src-container">
<pre class="src src-stata">display %4.3f e(r2_a)
</pre>
</div>

<pre class="example">
display %4.3f e(r2_a)
0.321

</pre>

<p>
Un affichage plus complexe pourrait inclure un mélange de texte et de résultat numérique, comme par exemple <code>display "R2 = " %5.2f e(r2_a)*100 "%"</code>, et une utilisation plus avancée consisterait à définir une macro locale pour stocker le résultat d&rsquo;un tel calcul, de manière statique ou dynamique.
</p>

<p>
L&rsquo;analyse des résidus d&rsquo;un modèle de régression est souvent négligée, pourtant elle permet de diagnostiquer assez rapidement la qualité d&rsquo;ajustement du modèle de manière graphique et de vérifier si les conditions de validité d&rsquo;interprétation du modèle (linéarité de la relation, constance de la variance) sont vérifiées ou non. Pour cela, on a essentiellement besoin des valeurs ajustées (c&rsquo;est-à-dire les valeurs prédites par le modèle linéaire pour les données observées) et des valeurs résiduelles, qui représentent l&rsquo;écart entre les valeurs observées et les valeurs ajustées. Une seule et même commande Stata, <a href="https://www.stata.com/help.cgi?predict" class="stata">predict</a>, permet de calculer ces deux séries de valeurs :
</p>
<div class="org-src-container">
<pre class="src src-stata">predict double yhat
predict double ei, rstandard
</pre>
</div>

<p>
Un simple diagramme de dispersion permettra ensuite d&rsquo;évaluer graphiquement la stabilité de la variance et l&rsquo;absence de pattern spécifique d&rsquo;évolution des résidus selon les valeurs ajustées. Comme les résidus calculés sont des résidus standardisés, on s&rsquo;attend à ce que 95 % des observations soit situées dans l&rsquo;intervalle \([-2,2]\). 
</p>
<div class="org-src-container">
<pre class="src src-stata">graph twoway scatter ei yhat, yline(0)
graph export "fig-00-rvfplot-price-mpg2.pdf", fontface(DroidSans) replace
</pre>
</div>


<div id="orgde635bd" class="figure">
<p><img src="./fig-00-rvfplot-price-mpg2.png" alt="fig-00-rvfplot-price-mpg2.png" width="640px" />
</p>
<p><span class="figure-number">Figure&nbsp;3&nbsp;: </span>Prix et vitesse des automobiles (valeurs ajustées et résidus)</p>
</div>

<p>
Pour rendre ce dernier graphique un peu plus informatif, on peut imaginer rajouter une courbe loess et annoter les observations ayant des résidus standardisés supérieurs à 2 (en valeur absolue).
</p>
<div class="org-src-container">
<pre class="src src-stata">generate infl = _n if abs(ei) &gt; 2
tostring infl, replace
replace infl = " " if infl == "."
scatter ei yhat, yline(0) || scatter ei yhat, ms(none) mlab(infl) mlabpos(12) || lowess ei yhat, legend(off)
graph export "fig-00-rvfplot-price-mpg2-b.pdf", fontface(DroidSans) replace
</pre>
</div>


<div id="org2b6a8b0" class="figure">
<p><img src="./fig-00-rvfplot-price-mpg2-b.png" alt="fig-00-rvfplot-price-mpg2-b.png" width="640px" />
</p>
<p><span class="figure-number">Figure&nbsp;4&nbsp;: </span>Prix et vitesse des automobiles (valeurs ajustées et résidus)</p>
</div>

<p>
Cette dernière série d&rsquo;instructions peut sembler un peu complexe lorsqu&rsquo;on n&rsquo;est pas familier avec la syntaxe Stata mais, en réalité, l&rsquo;idée est assez simple. On souhaite afficher l&rsquo;ensemble des observations à l&rsquo;aide de marqueurs comme dans la figure <a href="#orgde635bd">3</a> mais on souhaite annoter certains de ces points en indiquant le numéro d&rsquo;observation associé lorsque les résidus \(e_i = y_i - \hat{y}_i\) (<code>ei</code>) sont supérieurs à 2 en valeur absolue. Pour identifier ces observations avec des résidus élevés, on génère une nouvelle variable, <code>infl</code>, qui prendra la valeur <code>_n</code>, c&rsquo;est-à-dire le numéro de ligne, lorsque la condition est vérifiée. Cette variable est enseuite convertie au format chaîne de caractères et on remplace les valeurs manquantes (celles qui vérifient la condition \(\lvert e_i \rvert\le 2\)) par un espace afin d&rsquo;éviter l&rsquo;affichage d&rsquo;un point &laquo;&nbsp;.&nbsp;&raquo; dans le graphique.
</p>
</div>
</div>

<div id="outline-container-org8306261" class="outline-3">
<h3 id="org8306261">Synthétiser</h3>
<div class="outline-text-3" id="text-org8306261">
<p>
Comme on peut le constater, les tableaux renvoyés par Stata dans la fenêtre de résultats sont relativement convenables pour une lecture à l&rsquo;écran. En revanche, dans le cas de la génération d&rsquo;un rapport structuré d&rsquo;analyses, cette solution est limitée. Heureusement, il existe plusieurs possibilités pour exporter des tableaux générés par Stata au format texte, HTML ou PDF. Dans le dernier cas, cela nécessite de disposer d&rsquo;un compilateur LATEX.
</p>

<p>
Dans un premier temps, on va simplement reprendre les deux modèles précédents et sauvegarder les résultats d&rsquo;estimations. On pourrait très bien utiliser des macros locales pour stocker chacune des valeurs de retour mais cela risque de s&rsquo;avérer rapidement fastidieux. On utilisera donc la famille de commande <a href="https://www.stata.com/help.cgi?estimates" class="stata">estimates</a> :
</p>
<div class="org-src-container">
<pre class="src src-stata">quietly regress price mpg
estimates store m0
estimates title: Base model
quietly regress price mpg mpg2
estimates store m1
estimates title: Enhanced model
</pre>
</div>

<p>
Dans les instructions ci-dessus, le préfixe <a href="https://www.stata.com/help.cgi?quietly" class="stata">quietly</a> permet de réaliser l&rsquo;estimation sans afficher les résultats dans la fenêtre de résultats de Stata. Les noms <code>m0</code> et <code>m1</code> ne correspondent pas à des noms de variable mais nous permettront d&rsquo;identifier chacun des modèles par la suite. La commande <a href="https://www.stata.com/help.cgi?estimates" class="stata">estimates</a> s&rsquo;utilise immédiatement après la commande d&rsquo;estimation et permet de stocker les valeurs retournées par cette dernière : on parle de commande de &laquo;&nbsp;post-estimation&nbsp;&raquo;. 
</p>

<p>
Une fois stockés en mémoire, ces résultats d&rsquo;estimation peuvent être affichés à l&rsquo;aide de la commande <code>estimates table</code> :
</p>
<div class="org-src-container">
<pre class="src src-stata">estimates table m*, b(%7.2f) se(%7.2f) stats(N r2_a)
</pre>
</div>

<pre class="example">
estimates table m*, b(%7.2f) se(%7.2f) stats(N r2_a)

----------------------------------
    Variable |   m0        m1     
-------------+--------------------
         mpg | -238.89   -1265.19  
             |   53.08    289.54  
        mpg2 |             21.36  
             |              5.94  
       _cons | 11253.06   22716.48  
             | 1170.81   3366.58  
-------------+--------------------
           N |      74        74  
        r2_a |    0.21      0.32  
----------------------------------
                      legend: b/se
</pre>

<p>
Les options ajoutées dans l&rsquo;instruction précédente permettent d&rsquo;ajouter les erreurs standard aux coefficients de régression, qui sont affichés par défaut avec <code>estimates table</code>, avec un formatage précis (7 positions réservées pour les chiffres dont deux décimales), ainsi que la taille de l&rsquo;échantillon et le coefficient \(R^2\) ajusté. Il ne reste plus qu&rsquo;à exporter ce tableau à l&rsquo;aide de <code>estout</code>. Voici une première ébauche :
</p>
<div class="org-src-container">
<pre class="src src-stata">estout m0 m1, cells(b se) stats(N r2_a)
</pre>
</div>

<pre class="example">
estout m0 m1, cells(b se) stats(N r2_a)

--------------------------------------
                       m0           m1
                     b/se         b/se
--------------------------------------
mpg             -238.8943    -1265.194
                 53.07669     289.5443
mpg2                          21.36069
                              5.938885
_cons            11253.06     22716.48
                 1170.813     3366.577
--------------------------------------
N                      74           74
r2_a             .2087437     .3212682
--------------------------------------
</pre>

<p>
Comme on peut le constater, moyennant le formatage des nombres, il s&rsquo;agit à peu près du même résultat que celui produit par <code>estimates table</code>. 
Voici notre commande finale, avec quelques améliorations de mise en page et de formatage des nombres :
</p>
<div class="org-src-container">
<pre class="src src-stata">estout m*, cells("b(fmt(3) label(Coef.)) p(label(P-value))" "se(label(SE)) t(par fmt(2))") ///
  stats(N r2_a, labels("Sample size" R-squared) fmt(0 3))
</pre>
</div>

<p>
Voici le résultat produit par la dernière commande :
</p>
<pre class="example">
----------------------------------------------------------------
                       m0                        m1             
                 Coef./SE    P-value/t     Coef./SE    P-value/t
----------------------------------------------------------------
mpg              -238.894        0.000    -1265.194        0.000
                   53.077      (-4.50)      289.544      (-4.37)
mpg2                                         21.361        0.001
                                              5.939       (3.60)
_cons           11253.061        0.000    22716.476        0.000
                 1170.813       (9.61)     3366.577       (6.75)
----------------------------------------------------------------
Sample size            74                        74             
R-squared           0.209                     0.321             
----------------------------------------------------------------
</pre>

<p>
Pour sauvegarder ce tableau au format texte, il suffira de rajouter <code>using estout.txt</code> avant la virgule qui précède la liste d&rsquo;options. Notons qu&rsquo;il est possible de remplacer les étapes impliquant <code>quietly regress</code> et <code>estimates store</code> à l&rsquo;aide de <code>eststo:</code> qui fournit le même résultat. Il existe bien d&rsquo;autres options qui peuvent être consultées sur le <a href="http://repec.sowi.unibe.ch/stata/estout/">site dédié à estout</a>. La commande <code>tabout</code> permet quant à elle de générer et d&rsquo;exporter des tableaux complexes dans de nombreux formats. On pourra consulter l&rsquo;ancien tutoriel de l&rsquo;auteur Ian Watson, <a href="http://ianwatson.com.au/stata/tabout_tutorial.pdf">Publication quality tables in Stata: a tutorial for the tabout program</a> (PDF), et visiter le site de la <a href="http://tabout.net.au/docs/home.php">version 3 de tabout</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-orgc512251" class="outline-2">
<h2 id="orgc512251">Enregistrer son travail</h2>
<div class="outline-text-2" id="text-orgc512251">
<p>
Pour sauvegarder tout ce travail, il suffit de créer un script de commandes Stata, appelé &laquo;&nbsp;do file&nbsp;&raquo;, qui est un simple fichier texte avec l&rsquo;extension &laquo;&nbsp;.do&nbsp;&raquo;. Voici un exemple de fichier, <code>session.do</code>, qui regroupe les principales commandes exploitées dans ce tutoriel :
</p>
<pre class="example">
version 15
set more off
capture log close 
log using session, text

/* data source */
sysuse auto, clear
summarize mpg price

generate mpg2 = mpg*mpg


/* EDA */
graph twoway scatter price mpg || qfit price mpg
graph export "fig-00-scatter-price-mpg2.pdf", eplace

/* MOD */
eststo: quietly regress price mpg
eststo: quietly regress price mpg mpg2

/* Report */
estout m*, cells("b(fmt(3) label(Coef.)) p(label(P-value))" "se(label(SE)) t(par fmt(2))") ///
  stats(N r2_a, labels("Sample size" R-squared) fmt(0 3))

log close  
</pre>
</div>
</div>

<div id="outline-container-orga01cf06" class="outline-2">
<h2 id="orga01cf06">Pour aller plus loin</h2>
<div class="outline-text-2" id="text-orga01cf06">
<p>
On trouve de nombreux tutoriels sur internet (la plupart du temps en anglais). En voici quelques-un :
</p>

<ul class="org-ul">
<li>les ressources Stata ainsi que le blog Stata</li>
<li>le site pédagogique de l&rsquo;UCLA</li>
</ul>

<div id="bibliography">
<h2>Références</h2>

<table>

<tr valign="top">
<td align="right" class="bibtexnumber">
[<a name="baum-2006-introd-moder">1</a>]
</td>
<td class="bibtexitem">
Christopher&nbsp;F. Baum.
 <em>An Introduction to Modern Econometrics Using Stata</em>.
 Stata Press, 2006.

</td>
</tr>


<tr valign="top">
<td align="right" class="bibtexnumber">
[<a name="cox-2005-stata">2</a>]
</td>
<td class="bibtexitem">
Nick Cox.
 A brief history of Stata on its 20th anniversary.
 <em>The Stata Journal</em>, 5(1):2--18, 2005.

</td>
</tr>


<tr valign="top">
<td align="right" class="bibtexnumber">
[<a name="juul-2014-introd-stata">3</a>]
</td>
<td class="bibtexitem">
Svend Juul and Morten Frydenberg.
 <em>An Introduction to Stata for Health Researchers</em>.
 Stata Press, 4 edition, 2014.

</td>
</tr>


<tr valign="top">
<td align="right" class="bibtexnumber">
[<a name="kohler-2012-data-analy">4</a>]
</td>
<td class="bibtexitem">
Ulrich Kohler and Frauke Kreuter.
 <em>Data Analysis Using Stata</em>.
 Stata Press, 3 edition, 2012.

</td>
</tr>
</table>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Notes de bas de page: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
Si vous disposez d&rsquo;un terminal, vous pouvez vérifier à l&rsquo;aide de ces commandes (en adaptant le chemin d&rsquo;accès au répertoire Stata): <code>for i in /Applications/Stata/docs/*.pdf; do pdfinfo "$i" | grep "^Pages:"; done | awk '{s+=$2} END {print s}'</code>.
</p></div></div>


</div>
</div></div>
</body>
</html>
