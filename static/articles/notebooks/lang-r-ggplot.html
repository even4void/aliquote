<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-04-26 mar. 22:48 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Managing graphics with R</title>
<meta name="generator" content="Org mode">
<link rel="stylesheet" type="text/css" href="assets/worg.css" />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Managing graphics with R</h1>
<p>
R offers two main graphical systems: base and grid. The latter is exposed in two core packages: lattice and ggplot2. We will use the later, which relies on the idea of a "Grammar of Graphics" [<a href="#wilkinson-2005-gramm-graph">1</a>].
</p>

<div class="org-src-container">
<pre class="src src-R">suppressPackageStartupMessages(library(ggplot2))
theme_set(theme_bw())
</pre>
</div>

<p>
The above instructions allow to load the required package and to set a default theme. They are meant to be run only once, when R is started for the current session. However, it is still possible to change the theme at any time, or inline when building a custom graphical display.
</p>

<p>
Let's look at a random sample of the GSOEP dataset available in <code>data/gsoep09.dta</code>. This is a Stata file built upon the <a href="https://www.eui.eu/Research/Library/ResearchGuides/Economics/Statistics/DataPortal/GSOEP">German Socio Economic Survey</a> from 2009. Note that these data come with survey weights (<code>dweight</code> and <code>xweights</code>) but we will proceed as if it was a cross-sectional sample. The foreign package allows to read Stata files (up to Stata 12 version), but it is more convenient to use the haven package. The <code>read_dta</code> function will return a "tibble", which is like an ordinary data frame but with extra properties that we won't exploit in this tutorial.
</p>

<div class="org-src-container">
<pre class="src src-R">library(haven)
d &lt;- read_dta("data/gsoep09.dta")
head(as.data.frame(d))
</pre>
</div>

<pre class="example">

  persnr hhnr2009 state ybirth sex mar edu yedu   voc emp egp income hhinc hhsize hhsize0to14
1   8501       85     5   1932   1   1   1 10.0     1   5  18     NA 22093      2           0
2   8502       85     5   1939   2   1   1  8.7 NA(b)   5  18     NA 22093      2           0
3  15001      150     5   1946   1   1   1 10.0     1   5  18      0 62078      2           0
4  15002      150     5   1953   2   1   1 10.0     1   2   2  19955 62078      2           0
5  18201   111373    12   1969   1   4   2 12.0     2   1   4  35498 24578      1           0
6  18202      182    12   1946   2   1   4 15.0     2   5  18     NA 33401      2           0
  rel2head ymove ybuild condit dsat size seval rooms renttype rent reval eqphea eqpter eqpbas
1        1  1976      4      1    9 2046     4    10        1   NA NA(a)      1      1      1
2        2  1976      4      1    9 2045     4    10        1   NA NA(a)      1      1      1
3        1  1972      4      1    8  907     3     3        2  508 NA(a)      1      1      1
4        2  1972      4      1    9  900     3     3        2  530 NA(a)      1      1      1
5        1  2002  NA(a)      1    9 1292     3     4        1   NA NA(a)      1      2      1
6        1  2002  NA(a)      1    8  866     3     3        1   NA NA(a)      1      2      1
  eqpgar eqpalm eqpsol eqpair eqplif eqpnrj hhtyp area1 area2 dvisits heval hsat polint pia pib
1      1      2      2      1      2      1     2     2     1      20     5    2      1   1   5
2      1      2      2      1      2      1     2     2     1      24     4    2      3   1   5
3      1      2      2      2      2      2     2     4     2      12     3    5      3   1  NA
4      1      2      2      2      2      2     2     4     2       8     2    6      3   1   1
5      2      2      2      2      2      2     1     1     1      12     2    8      4   2  NA
6      2      2      2      2      2      2     2     1     1      12     3    7      4   2  NA
    pic lsat wor01 wor02 wor03 wor04 wor05 wor06 wor07 wor08 wor09 wor10 wor11 wor12 sample intnr
1     1    8     1     2     1     1     1     1     2     1     1     3     1 NA(b)      6    18
2     2    8     1     2     1     1     1     1     2     1     1     3     1 NA(b)      6    18
3 NA(b)    8     2     2     2     1     2     2     2     2     1     2     2 NA(b)      1    40
4     3    8     1     2     2     2     2     2     2     2     2     2     2     3      1    40
5 NA(b)    7     2     2     2     2     2     2     2     1     2     1     2     1      3    60
6 NA(b)    6     1     1     1     1     1     2     1     1     1     1     1 NA(b)      3    60
  hhnr strata    psu   dweight  xweights
1   85    601 601367 13569.429  5808.710
2   85    601 601367 13569.429  5283.054
3  150    101 101190 12894.620 11958.257
4  150    101 101190 12894.620 12114.272
5  182    301 301021  7326.489  4709.853
6  182    301 301021  7326.489  4929.223
</pre>

<div id="outline-container-org5a6048c" class="outline-2">
<h2 id="org5a6048c"><span class="section-number-2">1</span> Data preprocessing</h2>
<div class="outline-text-2" id="text-1">
<p>
We will first subset the data frame by selecting only a dozen of variables, and then draw a random sample of 10% of the original dataset. Specifically, the variables we are interested in are described below:
</p>

<ul class="org-ul">
<li><code>persnr</code>: respondant ID</li>
<li><code>hhnr2009</code>: household ID</li>
<li><code>ybirth</code>: year of birth</li>
<li><code>sex</code>: sex of respondant</li>
<li><code>mar</code>: marital status</li>
<li><code>egp</code>: socio-economic class</li>
<li><code>yedu</code>: no. years of education</li>
<li><code>income</code>: annual income (€)</li>
<li><code>rel2head</code>: position of respondant relative to household</li>
<li><code>wor01</code> to <code>wor12</code>: 3-point Likert answers to socio-economic and political questions</li>
</ul>

<div class="org-src-container">
<pre class="src src-R">vars &lt;- c("persnr", "hhnr2009", "ybirth", "sex", "mar", "egp", "yedu", "income", "rel2head",
	  "wor01", "wor02", "wor03", "wor04", "wor05", "wor06", "wor07", "wor08", "wor09", "wor10", "wor11", "wor12")
set.seed(101)
idx &lt;- sample(1:nrow(d), floor(nrow(d)*.1))
d &lt;- subset(d[idx, ], select = vars)
dim(d)
</pre>
</div>

<pre class="example">

[1] 541  21
</pre>


<p>
The next step consists in re-encoding categorical variables and computing auxiliary variables:
</p>

<div class="org-src-container">
<pre class="src src-R">d$persnr &lt;- factor(d$persnr)
d$hhnr2009 &lt;- factor(d$hhnr2009)
d$sex &lt;- droplevels(as_factor(d$sex))
d$mar &lt;- droplevels(as_factor(d$mar))
d$egp &lt;- droplevels(as_factor(d$egp))
d$rel2head &lt;- droplevels(as_factor(d$rel2head))
d$age &lt;- 2009 - d$ybirth
</pre>
</div>

<p>
Let us now look at the above variables, and recode some of <code>mar</code> and <code>egp</code> categories: (For simplicity, we will discard all refusals from the present dataset.)
</p>

<div class="org-src-container">
<pre class="src src-R">table(d$mar)
levels(d$mar)[3:5] &lt;- "Single"
d$mar[d$mar == "Refusal"] &lt;- NA
d$mar &lt;- droplevels(d$mar)
table(d$mar)
</pre>
</div>

<pre class="example">

  Married    Single   Widowed  Divorced Separated 
      293       143        50        43        12

Married  Single 
    293     248
</pre>


<div class="org-src-container">
<pre class="src src-R">table(d$egp)
levels(d$egp)[1:2] &lt;- "High"
levels(d$egp)[2:4] &lt;- "Mid"
levels(d$egp)[3:4] &lt;- "Low"
levels(d$egp)[4:6] &lt;- "None"
d$egp[d$egp == "Refusal"] &lt;- NA
d$egp &lt;- droplevels(d$egp)
table(d$egp)
</pre>
</div>

<pre class="example">

                   Service class 1                    Service class 2 
                                36                                 72 
        Higher routine non-manuals          Lower routine non-manuals 
                                29                                 33 
                     Self-Employed             Skilled manual workers 
                                25                                 40 
Semi- and unskilled manual workers                         unemployed 
                                60                                 27 
                           Retired                     Does not apply 
                               154                                 62 
                           Refusal 
                                 3

High  Mid  Low None 
 108   87  100  243
</pre>

<p>
Finally, let us only keep individuals with available income, and no missing value on <code>mar</code> or <code>egp</code>:
</p>

<div class="org-src-container">
<pre class="src src-R">d &lt;- subset(d, income &gt; 0 &amp; !is.na(mar) &amp; !is.na(egp))
d$logincome &lt;- log(d$income)
dim(d)
</pre>
</div>

<pre class="example">

[1] 336  23
</pre>
</div>
</div>

<div id="outline-container-org1567f81" class="outline-2">
<h2 id="org1567f81"><span class="section-number-2">2</span> The ggplot philosophy</h2>
<div class="outline-text-2" id="text-2">
<p>
In the spirit of the <i>Grammar of Graphics</i> developped by Leland Wilkinson, the <a href="https://ggplot2.tidyverse.org/">ggplot2</a> library uses a system of layers where graphical elements are joined altogether in a coherent way.
</p>


<div id="org5c384e2" class="figure">
<p><img src="./assets/lang-r-ggplot-001.png" alt="lang-r-ggplot-001.png" width="640px">
</p>
<p><span class="figure-number">Figure 1: </span>The Grammar of Graphics principles</p>
</div>

<p>
The following elements are usually found, in more or less the following order:
</p>

<ul class="org-ul">
<li><code>ggplot()</code>: a data frame (<code>data=</code>) together with a mapping (<code>aes()</code>)</li>
<li><code>geom_*()</code>: one or more geometrical objects</li>
<li><code>facet_wrap()</code>: a system of facets (used for conditioning on additional variables)</li>
<li><code>scale_*_*()</code>: a custom scale for each axis and color schemes</li>
<li><code>coord_*()</code>: a coordinate system</li>
<li><code>labs()</code>: some annotations for axes and other graphical properties</li>
<li><code>theme_*()</code>: a custom theme</li>
</ul>

<p>
Basically, we start by indicating the data frame in which the variables can be found (<code>data =</code>), and what role these variables play in the plot (<code>aes(x</code>, y=, color=)=). Two numerical variables can be used to code the spatial location of a point in a 2D space, while a categorical variable could be used to highligtht those points using color values mapped onto variable levels. The type of graphical object we wan to draw (<code>geom_point()</code>, <code>geom_histogram()</code>) depends on the number and the type of variables available in the <code>aes()</code> mapping. If there's only one numeric variable, we cannot draw a scatterplot, of course, but we can build an histogram, for example. Note that a single plot can contain multiple geometrical object, e.g. a scatterplot and a scatterplot smoother (lowess curve). Each plot can be customized in several ways, but most of the time we may be interested in updating the axes or the object properties (e.g., <code>scale_x_continuous()</code>, <code>scale_color_manual()</code>), and the labels or the title/subtitle (<code>labs()</code>).
</p>

<p>
The most up to date documentation is available on-line in Winston Chang's <a href="https://r-graphics.org/">R Graphics Cookbook</a> [<a href="#chang-2013-r-graph-cookb">2</a>].
</p>
</div>

<div id="outline-container-org2c53133" class="outline-3">
<h3 id="org2c53133"><span class="section-number-3">2.1</span> Illustration of the layered approach</h3>
<div class="outline-text-3" id="text-2-1">
<p>
A very basic plot can be thought of as a succession of layers. In the example below, we first draw a scatterplot using variable <code>lwt</code> (on the x-axis) and <code>bwt</code> (on the y-axis) from the <code>MASS::birthwt</code> dataset, and then add a scatterplot smoother (a lowess curve, with default smoothing parameters) on top of the scatterplot:
</p>

<pre class="example">
p &lt;- ggplot() +
    layer(data = MASS::birthwt,
          stat = "identity",
          geom = "point",
          mapping = aes(x = lwt, y = bwt),
          position = "identity") +
    layer(data = MASS::birthwt,
          stat = "smooth",
          geom = "line",
          mapping = aes(x = lwt, y = bwt),
          position = "identity",
          params = list(method = "auto"))
</pre>

<p>
Here is the simplified version using the approach described above:
</p>

<div class="org-src-container">
<pre class="src src-R">library(MASS)
p &lt;- ggplot(data = birthwt, aes(x = lwt, y = bwt))
p + geom_point() + geom_smooth(method = "auto")
</pre>
</div>


<div class="figure">
<p><img src="assets/lang-r-ggplot-002.png" alt="lang-r-ggplot-002.png">
</p>
</div>

<p>
This follows the same principled approach: You add each graphical piece together using the <code>+</code> operateur &#x2013; which is specific to ggplot2 &#x2013; and you print the final graphical object to the graphical device. This is the reason why we don't use any assignment operateur (<code>&lt;-</code>) in the last expression. It would be possible to write the following expression:
</p>

<pre class="example">
ggplot(data = birthwt, aes(x = lwt, y = bwt)) + geom_point() + geom_smooth(method = "auto")
</pre>

<p>
However, it is better practice to save the graphical commands in a variable, and even to accumulate (<code>+</code>) the instructions as they go along since this allows to build the final plot in an incremental way.
</p>
</div>
</div>
</div>

<div id="outline-container-org869b627" class="outline-2">
<h2 id="org869b627"><span class="section-number-2">3</span> Exploratory analysis</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgad9607e" class="outline-3">
<h3 id="orgad9607e"><span class="section-number-3">3.1</span> Histogram and density estimators</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Histogram and density curve are two common estimators for the distribution of a continuous random variable. They do indeed have their counterparts in ggplot2, namely <code>geom_histogram</code> and <code>geom_density</code>, although in the latter case it is also possible to use <code>geom_line</code> using the a density estimator that ggplot2 will compute for us. Here are two examples of use:
</p>

<div id="bibliography">
<h2>References</h2>

<table>

<tr valign="top">
<td align="right" class="bibtexnumber">
[<a name="wilkinson-2005-gramm-graph">1</a>]
</td>
<td class="bibtexitem">
L.&nbsp;Wilkinson, <em>The Grammar of Graphics</em>.
 Springer, 2005.

</td>
</tr>


<tr valign="top">
<td align="right" class="bibtexnumber">
[<a name="chang-2013-r-graph-cookb">2</a>]
</td>
<td class="bibtexitem">
W.&nbsp;Chang, <em>R Graphics Cookbook</em>.
 O’Reilly Media, Inc., 2013.

</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
Generated by <a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.3 (<a href="https://orgmode.org">Org</a> mode 9.3.1) on 2022-04-26 mar. 22:48 (<a href="mailto:chl@aliquote">chl@aliquote</a>)
</div>
</body>
</html>
